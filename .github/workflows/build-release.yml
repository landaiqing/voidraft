name: Build and Release Voidraft

on:
  # æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼ˆç”¨äºæ­£å¼å‘å¸ƒï¼‰
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
    branches:
      - main  # ä»…å½“æ ‡ç­¾åœ¨ main åˆ†æ”¯æ—¶è§¦å‘
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      release:
        description: 'æ˜¯å¦åˆ›å»º Releaseï¼ˆæµ‹è¯•æ—¶é€‰ falseï¼‰'
        required: true
        type: boolean
        default: false
      platforms:
        description: 'è¦æ„å»ºçš„å¹³å°ï¼ˆç”¨é€—å·åˆ†éš”ï¼šwindows,linux,macos-intel,macos-armï¼‰'
        required: true
        type: string
        default: 'windows,linux'

env:
  NODE_OPTIONS: "--max-old-space-size=4096"  # é˜²æ­¢ Node.js å†…å­˜æº¢å‡º

jobs:
  # å‡†å¤‡æ„å»ºé…ç½®
  prepare:
    permissions: {}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should_release: ${{ steps.check-release.outputs.should_release }}
    steps:
      - name: ç¡®å®šæ„å»ºå¹³å°
        id: set-matrix
        run: |
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œæ ¹æ®è¾“å…¥å†³å®šå¹³å°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PLATFORMS="${{ github.event.inputs.platforms }}"
          else
            # æ ‡ç­¾è§¦å‘ï¼Œæ„å»ºæ‰€æœ‰å¹³å°
            PLATFORMS="windows,linux,macos-intel,macos-arm"
          fi
          
          echo "æ„å»ºå¹³å°: $PLATFORMS"
          
          # æ„å»ºçŸ©é˜µ JSON
          MATRIX='{"include":[]}'
          
          if [[ "$PLATFORMS" == *"windows"* ]]; then
            MATRIX=$(echo "$MATRIX" | jq -c '.include += [{"platform":"windows-latest","os":"windows","arch":"amd64","platform_dir":"windows","id":"windows"}]')
          fi
          
          if [[ "$PLATFORMS" == *"linux"* ]]; then
            MATRIX=$(echo "$MATRIX" | jq -c '.include += [{"platform":"ubuntu-22.04","os":"linux","arch":"amd64","platform_dir":"linux","id":"linux"}]')
          fi
          
          if [[ "$PLATFORMS" == *"macos-intel"* ]]; then
            MATRIX=$(echo "$MATRIX" | jq -c '.include += [{"platform":"macos-latest","os":"darwin","arch":"amd64","platform_dir":"darwin","id":"macos-intel"}]')
          fi
          
          if [[ "$PLATFORMS" == *"macos-arm"* ]]; then
            MATRIX=$(echo "$MATRIX" | jq -c '.include += [{"platform":"macos-latest","os":"darwin","arch":"arm64","platform_dir":"darwin","id":"macos-arm"}]')
          fi
          
          # ä½¿ç”¨ -c ç¡®ä¿è¾“å‡ºç´§å‡‘çš„å•è¡Œ JSONï¼Œç¬¦åˆ GitHub Actions è¾“å‡ºæ ¼å¼
          echo "matrix=$(echo "$MATRIX" | jq -c .)" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºç¾åŒ–çš„ JSON ç”¨äºæ—¥å¿—æŸ¥çœ‹
          echo "ç”Ÿæˆçš„çŸ©é˜µ:"
          echo "$MATRIX" | jq .
      
      - name: æ£€æŸ¥æ˜¯å¦åˆ›å»º Release
        id: check-release
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼Œæ ¹æ®è¾“å…¥å†³å®š
            echo "should_release=${{ github.event.inputs.release }}" >> $GITHUB_OUTPUT
          else
            # æ ‡ç­¾è§¦å‘ï¼Œè‡ªåŠ¨åˆ›å»º Release
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  build:
    permissions:
      contents: read
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.matrix).include[0] != null }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    runs-on: ${{ matrix.platform }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Linux å¹³å°ä¾èµ–
      - name: å®‰è£… Linux ä¾èµ–
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          # Wails 3 + é¡¹ç›®ç‰¹å®šä¾èµ–
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libx11-dev \
            rpm \
            fuse \
            file
          
          # ä¾èµ–è¯´æ˜ï¼š
          # - build-essential: C/C++ ç¼–è¯‘å·¥å…·é“¾
          # - pkg-config: åŒ…é…ç½®å·¥å…·
          # - libgtk-3-dev: GTK3 GUI æ¡†æ¶
          # - libwebkit2gtk-4.1-dev: WebKit2GTK 4.1 (Wails 3 è¦æ±‚)
          # - libayatana-appindicator3-dev: ç³»ç»Ÿæ‰˜ç›˜æ”¯æŒ
          # - librsvg2-dev: SVG å›¾æ ‡æ”¯æŒ
          # - patchelf: ä¿®æ”¹ ELF äºŒè¿›åˆ¶æ–‡ä»¶
          # - libx11-dev: X11 åº“ (çƒ­é”®æœåŠ¡ä¾èµ–)
          # - rpm: RPM æ‰“åŒ…å·¥å…·
          # - fuse: AppImage è¿è¡Œä¾èµ–
          # - file: æ–‡ä»¶ç±»å‹æ£€æµ‹å·¥å…·

      # Windows å¹³å°ä¾èµ–
      - name: è®¾ç½® Windows æ„å»ºç¯å¢ƒ
        if: matrix.os == 'windows'
        run: |
          # å®‰è£… NSIS (ç”¨äºåˆ›å»ºå®‰è£…ç¨‹åº)
          choco install nsis -y
          # å°† NSIS æ·»åŠ åˆ° PATH
          echo "C:\Program Files (x86)\NSIS" >> $GITHUB_PATH
        shell: bash

      # macOS å¹³å°ä¾èµ–
      - name: è®¾ç½® macOS æ„å»ºç¯å¢ƒ
        if: matrix.os == 'darwin'
        run: |
          # Xcode å‘½ä»¤è¡Œå·¥å…·é€šå¸¸å·²å®‰è£…
          xcode-select --install 2>/dev/null || true

      # å®‰è£… Wails CLI
      - name: å®‰è£… Wails CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      # å®‰è£…å‰ç«¯ä¾èµ–
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: frontend
        run: npm ci

      # æ„å»ºå‰ç«¯
      - name: æ„å»ºå‰ç«¯
        working-directory: frontend
        run: npm run build

      # ä½¿ç”¨ Wails Task æ„å»ºå’Œæ‰“åŒ…åº”ç”¨
      - name: æ„å»ºå’Œæ‰“åŒ… Wails åº”ç”¨
        run: wails3 task ${{ matrix.id }}:package PRODUCTION=true ARCH=${{ matrix.arch }}
        env:
          CGO_ENABLED: 1
          APP_NAME: voidraft
          BIN_DIR: bin
          ROOT_DIR: .
        shell: bash

      # æ•´ç†æ„å»ºäº§ç‰©
      - name: æ•´ç†æ„å»ºäº§ç‰©
        id: organize_artifacts
        run: |
          echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
          ls -lhR bin/ || echo "bin ç›®å½•ä¸å­˜åœ¨"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p artifacts
          
          # æ ¹æ®å¹³å°å¤åˆ¶äº§ç‰©
          if [ "${{ matrix.os }}" = "windows" ]; then
            echo "Windows å¹³å°ï¼šæŸ¥æ‰¾ NSIS å®‰è£…ç¨‹åº"
            find . -name "*.exe" -type f
            cp bin/*.exe artifacts/ 2>/dev/null || echo "æœªæ‰¾åˆ° .exe æ–‡ä»¶"
            
          elif [ "${{ matrix.os }}" = "linux" ]; then
            echo "Linux å¹³å°ï¼šæŸ¥æ‰¾ AppImage, deb, rpm, archlinux åŒ…"
            find bin -type f
            cp bin/*.AppImage artifacts/ 2>/dev/null || echo "æœªæ‰¾åˆ° AppImage"
            cp bin/*.deb artifacts/ 2>/dev/null || echo "æœªæ‰¾åˆ° deb"
            cp bin/*.rpm artifacts/ 2>/dev/null || echo "æœªæ‰¾åˆ° rpm"
            cp bin/*.pkg.tar.zst artifacts/ 2>/dev/null || echo "æœªæ‰¾åˆ° archlinux åŒ…"
            
          elif [ "${{ matrix.os }}" = "darwin" ]; then
            echo "macOS å¹³å°ï¼šæŸ¥æ‰¾ .app bundle"
            find bin -name "*.app" -type d
            # macOS: .app bundleï¼Œæ‰“åŒ…æˆ zip
            if [ -d "bin/voidraft.app" ]; then
              cd bin
              zip -r ../artifacts/voidraft-darwin-${{ matrix.arch }}.app.zip voidraft.app
              cd ..
            else
              echo "æœªæ‰¾åˆ° .app bundle"
            fi
          fi
          
          echo "=== æœ€ç»ˆäº§ç‰© ==="
          ls -lh artifacts/ || echo "artifacts ç›®å½•ä¸ºç©º"
        shell: bash

      # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: voidraft-${{ matrix.id }}
          path: artifacts/*
          if-no-files-found: warn

  # åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
  release:
    needs: [prepare, build]
    if: ${{ needs.prepare.outputs.should_release == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "ä¸‹è½½çš„æ„å»ºäº§ç‰©ï¼š"
          ls -R artifacts/

      - name: å‡†å¤‡ Release æ–‡ä»¶
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -lh release/

      - name: ç”Ÿæˆ Release è¯´æ˜
        id: release_notes
        run: |
          # è·å–ç‰ˆæœ¬å·
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.sha }}"
            VERSION_NAME="æµ‹è¯•æ„å»º ${VERSION:0:7}"
          else
            VERSION="${{ github.ref_name }}"
            VERSION_NAME="${VERSION}"
          fi
          
          cat > release_notes.md << EOF
          ## Voidraft ${VERSION_NAME}
          
          ### ğŸ“¦ ä¸‹è½½
          
          æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š
          
          - **Windows (64ä½)**: \`voidraft-windows-amd64.exe\`
          - **Linux (64ä½)**: \`voidraft-linux-amd64\`
          - **macOS (Intel)**: \`voidraft-darwin-amd64.zip\`
          - **macOS (Apple Silicon)**: \`voidraft-darwin-arm64.zip\`
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹ [æäº¤å†å²](../../commits/${{ github.ref_name }}) äº†è§£æœ¬æ¬¡æ›´æ–°çš„è¯¦ç»†å†…å®¹ã€‚
          
          ### ğŸ’¡ ä½¿ç”¨è¯´æ˜
          
          #### Windows
          1. ä¸‹è½½ `voidraft-windows-amd64.exe`
          2. ç›´æ¥è¿è¡Œå³å¯
          
          #### Linux
          1. ä¸‹è½½ `voidraft-linux-amd64`
          2. æ·»åŠ æ‰§è¡Œæƒé™ï¼š`chmod +x voidraft-linux-amd64`
          3. è¿è¡Œï¼š`./voidraft-linux-amd64`
          
          #### macOS
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ zip æ–‡ä»¶
          2. è§£å‹åè¿è¡Œ
          3. å¦‚æœæç¤ºæ— æ³•æ‰“å¼€ï¼Œè¯·åœ¨ ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ ä¸­å…è®¸è¿è¡Œ
          
          ---
          
          æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event_name == 'workflow_dispatch' }}
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('test-{0}', github.sha) || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && format('æµ‹è¯•æ„å»º {0}', github.sha) || github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

